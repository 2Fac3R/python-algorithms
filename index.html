<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Training Plan</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 1em; color: #333; background-color: #fdfdfd; }
        h1, h2, h3 { color: #005f73; }
        a { color: #0077cc; text-decoration: none; cursor: pointer; }
        a:hover { text-decoration: underline; }
        .container { display: flex; gap: 2em; max-width: 1400px; margin: 0 auto; }
        .sidebar { flex: 0 0 380px; max-height: 95vh; overflow-y: auto; padding-right: 1em; }
        .content-view { flex: 1; min-width: 0; }
        .section { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1em 1.5em; margin-bottom: 1.5em; }
        .section h2 { margin-top: 0; border-bottom: 2px solid #e9ecef; padding-bottom: 0.5em; }
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 1.25em; }
        .file-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 5px; }
        .file-link { background-color: #fff; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; font-family: monospace; font-size: 0.85em; }
        .file-link.theory { border-left: 3px solid #0077cc; }
        .file-link.challenge { border-left: 3px solid #2a9d8f; }
        .file-link.exam { border-left: 3px solid #e76f51; }
        .file-link.cheatsheet { border-left: 3px solid #9b59b6; }
        #content-display { border: 1px solid #dee2e6; border-radius: 8px; padding: 0 2em 2em 2em; background-color: #fff; min-height: 90vh; }
        #content-display h1, #content-display h2 { padding-bottom: 0.5em; border-bottom: 2px solid #e9ecef; }
        #content-display pre[class*="language-"] { background-color: #272822; }
        #content-display code { font-family: monospace; }
        #content-display :not(pre) > code { background-color: #f3f4f6; padding: 2px 4px; border-radius: 3px; }
        #content-display table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        #content-display th, #content-display td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
        #content-display th { background-color: #f2f2f2; }
        .solution-toggle { display: inline-block; background-color: #e76f51; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 1em; }
        .solution-toggle:hover { background-color: #f4a261; }
        .solution-container { border: 1px dashed #f4a261; margin-top: 1em; padding: 0 1.5em; background-color: #fffbf7; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div id="table-of-contents">
                <!-- Sidebar content will be generated by script -->
            </div>
        </div>
        <div class="content-view">
            <div id="content-display">
                <h2>Welcome!</h2>
                <p>Select a file from the list on the left to view its content here.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script src="js/content_fundamentals.json"></script>
    <script src="js/content_techniques.json"></script>
    <script src="js/content_design_patterns.json"></script>
    <script src="js/content_aws.json"></script>

    <script>
        const contentDisplay = document.getElementById('content-display');
        const toc = document.getElementById('table-of-contents');

        function buildSidebar(contentMap) {
            const buildSectionHTML = (items) => {
                return items.map(item => {
                    const challengesHTML = (item.challenges || []).map(c => 
                        `<a data-src="${c.path}" data-type="python" data-solution-src="${c.solution}" class="file-link challenge" title="${c.path}">${c.name}</a>`
                    ).join('');
                    const examHTML = item.exam ? `<a data-src="${item.exam.path}" data-type="markdown" data-solution-src="${item.exam.solution}" class="file-link exam">Exam</a>` : '';
                    return (
                        `<li><strong>${item.name}:</strong><div class="file-group">
                            <a data-src="${item.theory}" data-type="markdown" class="file-link theory">Theory</a>
                            ${challengesHTML}
                            ${examHTML}
                            <a data-src="${item.cheatsheet}" data-type="markdown" class="file-link cheatsheet">Cheatsheet</a>
                        </div></li>`
                    );
                }).join('');
            };

            const buildAwsSectionHTML = (items) => {
                return items.map(item => {
                    const links = {
                        'Theory': { path: item.theory, class: 'theory' },
                        'Key Services': { path: item.key_services, class: 'challenge' },
                        'Hands-On': { path: item.hands_on, class: 'challenge' },
                        'Exam': { path: item.exam?.path || item.exam, class: 'exam', solution: item.exam?.solution },
                        'Cheatsheet': { path: item.cheatsheet, class: 'cheatsheet' }
                    };

                    const linksHTML = Object.entries(links).map(([name, data]) => {
                        if (data && data.path) {
                            const solutionAttr = data.solution ? `data-solution-src="${data.solution}"` : '';
                            return `<a data-src="${data.path}" data-type="markdown" ${solutionAttr} class="file-link ${data.class}">${name}</a>`;
                        }
                        return '';
                    }).join('');

                    return `<li><strong>${item.name}:</strong><div class="file-group">${linksHTML}</div></li>`;
                }).join('');
            };

            const fundamentalsHTML = buildSectionHTML(contentMap.fundamentals);
            const techniquesHTML = buildSectionHTML(contentMap.techniques);
            const designPatternsHTML = buildSectionHTML(contentMap.design_patterns);
            const awsHTML = buildAwsSectionHTML(contentMap.aws_practitioner);

            toc.innerHTML = (
                `<h1>Training Plan</h1>
                <div class="section"><h2>I. Fundamentals</h2><ul>${fundamentalsHTML}</ul></div>
                <div class="section"><h2>II. Problem Solving Techniques</h2><ul>${techniquesHTML}</ul></div>
                <div class="section"><h2>III. Design Patterns</h2><ul>${designPatternsHTML}</ul></div>
                <div class="section"><h2>IV. AWS Cloud Practitioner</h2><ul>${awsHTML}</ul></div>`
            );
        }

        async function loadAndRender(url, type, solutionUrl) {
            try {
                const response = await fetch(url);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const textContent = await response.text();
                let renderedHTML = '';

                if (type === 'markdown') {
                    renderedHTML = marked.parse(textContent);
                } else if (type === 'python') {
                    let docstring = '', code = textContent, title = 'Challenge';
                    const docstringMatch = textContent.match(/"""([\s\S]*?)"""/);
                    if (docstringMatch) {
                        docstring = docstringMatch[1].trim();
                        code = textContent.replace(docstringMatch[0], '').trim();
                        const lines = docstring.split('\n');
                        const titleLine = lines.find(line => line.trim().toLowerCase().startsWith('challenge:'));
                        if (titleLine) {
                            title = titleLine.substring('challenge:'.length).trim();
                            const titleLineIndex = lines.findIndex(line => line.trim().toLowerCase().startsWith('challenge:'));
                            lines.splice(titleLineIndex, 1);
                            docstring = lines.join('\n');
                        }
                    }
                    const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                    renderedHTML = `<h1>${escapeHtml(title)}</h1>${marked.parse(docstring)}<pre><code class="language-python">${escapeHtml(code)}</code></pre>`;
                }

                contentDisplay.innerHTML = renderedHTML;

                if (solutionUrl) {
                    const solutionButtonHTML = `<br><hr><button class="solution-toggle" data-solution-src="${solutionUrl}" data-solution-type="${type}">Show Solution</button>`;
                    const solutionContainerHTML = `<div class="solution-container" style="display: none;"></div>`;
                    contentDisplay.innerHTML += solutionButtonHTML + solutionContainerHTML;
                }

                Prism.highlightAll();
            } catch (error) {
                contentDisplay.innerHTML = `<p style="color: red;"><strong>Error:</strong> Could not load content from <code>${url}</code>. ${error}</p><p>Remember to run this from a local server: <code>python3 -m http.server</code></p>`;
            }
        }

        toc.addEventListener('click', function(event) {
            const targetLink = event.target;
            if (targetLink.tagName === 'A' && targetLink.dataset.src) {
                event.preventDefault();
                loadAndRender(targetLink.dataset.src, targetLink.dataset.type, targetLink.dataset.solutionSrc);
            }
        });

        contentDisplay.addEventListener('click', async function(event) {
            const targetButton = event.target;
            if (targetButton.classList.contains('solution-toggle')) {
                const solutionContainer = targetButton.nextElementSibling;
                const solutionUrl = targetButton.dataset.solutionSrc;
                const solutionType = targetButton.dataset.solutionType;

                if (solutionContainer.style.display === 'none') {
                    if (!solutionContainer.innerHTML) {
                        try {
                            const response = await fetch(solutionUrl);
                            if (!response.ok) { throw new Error('Network response was not ok'); }
                            const solutionText = await response.text();
                            let solutionHTML = '';
                            if (solutionType === 'markdown') {
                                solutionHTML = marked.parse(solutionText);
                            } else {
                                const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                                solutionHTML = `<pre><code class="language-python">${escapeHtml(solutionText)}</code></pre>`;
                            }
                            solutionContainer.innerHTML = solutionHTML;
                            Prism.highlightAllUnder(solutionContainer);
                        } catch (error) {
                            solutionContainer.innerHTML = `<p style="color: red;">Could not load solution.</p>`;
                        }
                    }
                    solutionContainer.style.display = 'block';
                    targetButton.textContent = 'Hide Solution';
                } else {
                    solutionContainer.style.display = 'none';
                    targetButton.textContent = 'Show Solution';
                }
            }
        });

        // Load all content maps from JSON files
        Promise.all([
            fetch('js/content_fundamentals.json').then(res => res.json()),
            fetch('js/content_techniques.json').then(res => res.json()),
            fetch('js/content_design_patterns.json').then(res => res.json()),
            fetch('js/content_aws.json').then(res => res.json())
        ]).then(([fundamentals, techniques, design_patterns, aws_practitioner]) => {
            const contentMap = { fundamentals, techniques, design_patterns, aws_practitioner };
            buildSidebar(contentMap);
            // Load a default file
            loadAndRender('./training/fundamentals/00_python_fundamentals.md', 'markdown', "./exams/solutions/01_solution_python_fundamentals.md");
        }).catch(error => {
            console.error("Failed to load content maps:", error);
            toc.innerHTML = `<p style="color: red;"><strong>Error:</strong> Could not load the study plan data.</p>`;
        });

    </script>
</body>
</html>